<html>
<head>
<meta charset="utf-8">

<!--
 The SVG viewport is the scrolling / panning / zooming area, so
 prevent touch events from zooming into the page
 ( from https://www.html5rocks.com/en/mobile/touchandmouse/ )
-->
<meta name="viewport" content="width=device-width,user-scalable=no">

<script src="https://togetherjs.com/togetherjs-min.js"></script>
<script src="./svg_draggable.js"></script>
<script src="./come_together.js"></script>
<script src="./base32.js"></script>
<script src="./svg.js"></script>
<script src="./index.js"></script>

<link rel="stylesheet" type="text/css" href="animate.css">
<link rel="stylesheet" type="text/css" href="index.css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>


<script src="./lib/materialize/js/materialize.js"></script>
<link rel="stylesheet" type="text/css" href="./lib/materialize/css/materialize.css">

<style>

#object_actions {
  width: 100%;
  background-color: #a0a0a0;
  position:fixed;
  bottom:0px;
}

#object_actions h3 {
  display: inline;
}

</style>

</head>

<script>
var svg_table;
var viewport;
var gViewport;
var widget_panzoom;
SVG.on(document, 'DOMContentLoaded', () => {
  viewport = SVG('gamearea').size(1000, 480)
  viewport.node.id = 'svg_viewport'
  viewport.style('background-image', 'url(svg/bg_hexagons.svg)')

  gViewport = SVG.adopt(document.createElementNS(SVG.ns, 'g'))
  gViewport.node.id = 'g_viewport'
  viewport.add(gViewport)

  svg_table = SVG.adopt(document.createElementNS(SVG.ns, 'svg'))
  svg_table.node.id = 'svgtable'
  svg_table.size(1000, 480)
  gViewport.add(svg_table)

  SVG.eid = (name) => {
    return name + '_' + base32.short_id()
  }

  makeDraggable(svg_table, {
    endDragCb: (selectedElement) => {
      console.log('done drag', selectedElement)
      net_fire({type: "change", data: serialize(selectedElement)});
    }
  })

  widgetElem = document.querySelector('#widget_panzoom')
  widgetElem.addEventListener('load', () => {
    widget_panzoom = widgetElem.getSVGDocument().querySelector('svg');
    widget_panzoom = SVG.adopt(widget_panzoom)
    viewport.add(widget_panzoom)
    widget_panzoom.x( viewport.width() - widget_panzoom.width() )
    widget_panzoom.select('#x_left').on('click', () => pan(50, 0))
    widget_panzoom.select('#x_right').on('click', () => pan(-50, 0))
    widget_panzoom.select('#y_up').on('click', () => pan(0, 50))
    widget_panzoom.select('#y_down').on('click', () => pan(0, -50))
    widget_panzoom.select('#zoom_in').on('click', () => zoom('in'))
    widget_panzoom.select('#zoom_out').on('click', () => zoom('out'))
    widgetElem.remove()
  });

  // Initialize modals
  instances = M.Modal.init(document.querySelectorAll('.modal'), {
    opacity: 0.75,
  });
})

function pan(xDelta, yDelta) {
  prev = gViewport.transform()
  gViewport.transform( {x: prev.x + xDelta, y: prev.y + yDelta} )
}

var currentZoom = 1.0;
function zoom(inOrOut) {
  zooms = {
    0.25: { out: 0.25, in: 0.5 },
    0.5: { out: 0.25, in: 1.0 },
    1.0: { out: 0.5, in: 1.5 },
    1.5: { out: 1.0, in: 2.0 },
    2.0: { out: 1.5, in: 4.0 },
    4.0: { out: 2.0, in: 4.0 },
  }
  currentZoom = zooms[currentZoom][inOrOut];
  gViewport.transform( {scale: currentZoom} )
}

</script>

<body>
  <button class="btn" onclick="TogetherJS(this); return false;"
  >Start TogetherJS</button>

  <button class="btn" onclick="add_d6()">
  Add d6
  </button>

  <button class="btn" onclick="add_d8()">
  Add d8
  </button>

  <button class="btn" onclick="add_deckahedron()">
  Add Deckahedron
  </button>

  <button class="btn" id="delete_button" onclick="delete_marked(this)"
    title="double-click objects to mark and delete them"
    disabled="disabled"
  >
    Delete&nbsp;<span id="num_marked">0</span>&nbsp;Objects
  </button>

  <button id="bg_button" class="btn modal-trigger"
    data-target="dialog_bg"
    data-dialog-id="dialog_bg">
    Change Background
  </button>

  <button id="draw_button" class="btn modal-trigger"
    data-target="dialog_rect"
    data-dialog-id="dialog_rect">
    Draw rect
  </button>

  <button id="properties_button" class="btn modal-trigger"
    title="double-click objects to mark them"
    disabled="disabled"
    data-target="dialog_properties"
    data-dialog-id="dialog_properties">
    Object Properties
  </button>

  <button id="save_button" class="btn modal-trigger"
    data-target="dialog_save"
    data-dialog-id="dialog_save">
    Save
  </button>

  <button id="load_button" class="btn modal-trigger"
    data-target="dialog_load"
    data-dialog-id="dialog_load">
    Load
  </button>

  <button id="load_button" class="btn modal-trigger"
    data-target="dialog_contribute"
    data-dialog-id="dialog_contribute">
    Help this project
  </button>

  <div id="gamearea" contextmenu="gamemenu">
    <object id="widget_panzoom" data="svg/widget_panzoom.svg" type="image/svg+xml">
    </object>
  <!--
  <svg id="svgdoc" width="100%" height="500" onload="initDraggable()">
  </svg>
  -->
  </div>
  <div id="object_actions">
      <h3 id="object_actions_header">Obj heading</h3>
    <template id="template_object_actions">
      <button class="btn">Button label</button>
    </template>
  </div>

<!-- SAVE ============================================================ SAVE -->
  <div id="dialog_save" class="modal">
  <script>
function ui_popup_dialog_save() {
  textarea = byId('textarea_save_output')
  svg = byId('gamearea').querySelector('svg')
  textarea.innerHTML = svg.outerHTML
  return ui_popup_dialog({'data-dialog-id': 'dialog_save'})
}
  </script>
    <button class="btn dialog_cancel modal-close">
      &#215;
    </button>
    <nav class="dialog_nav"  id="save_nav">
    <div class="nav-wrapper">
      <ul class="left">
        <li><a href="#copy_and_paste">Copy/Paste</a></li>
        <li><a href="#local">Local storage</a></li>
        <li><a href="#cloud">Cloud storage</a></li>
      </ul>
    </div>
    </nav>
  <div class="modal-content">
    <section>
      <a name="copy_and_paste"></a>
      <h2 class="save_h2">Copy and Paste</h2>
      <textarea id="textarea_save_output" cols="82" rows=10>X</textarea>
      <div class="save_explain">
      Copy and paste the contents of this text box to a file on your computer.
      </div>
    </section>
    <section>
      <a name="local"></a>
      <h2 class="save_h2">Local storage on your browser</h2>
      <div class="save_explain">
      This feature has not been implemented yet. If you would like it to exist,
      <span style="color:teal">tweet</span> "Hey @boardcrafting, please
      make Local Storage work on http://1kfa.com/table ! #ttrpg #1kfa
      #featurerequest"
      <b>or</b> start participating with the development on Github
      </div>
    </section>
    <section>
      <a name="cloud"></a>
      <h2 class="save_h2">Cloud storage</h2>
      <div class="save_explain">
      This feature has not been implemented yet. If you would like it to exist,
      <span style="color:teal">tweet</span> "Hey @boardcrafting, please
      make Cloud Storage work on http://1kfa.com/table ! #ttrpg #1kfa
      #featurerequest"
      <b>or</b> start participating with the development on Github
      </div>
    </section>
  </div>
  </div>
<!-- /SAVE ========================================================== /SAVE -->


<!-- LOAD ============================================================ LOAD -->
  <div id="dialog_load" class="modal">
  <script>
function load_svg() {
  textarea = byId('textarea_load_input')
  svg = byId('gamearea').querySelector('svg')
  console.log('texar', textarea.value)
  svg.outerHTML = textarea.value
  ui_popdown_dialog('dialog_load')
}
  </script>
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_load"
    >
      &#215;
    </button>
    <nav class="dialog_nav" id="load_nav">
    <div class="nav-wrapper">
      <ul class="left">
        <li><a href="#copy_and_paste">Copy/Paste</a></li>
        <li><a href="#upload">Upload file</a></li>
      </ul>
    </div>
    </nav>
  <div class="modal-content">
    <section>
      <a name="copy_and_paste"></a>
      <h2 class="load_h2">Copy and Paste</h2>
      <textarea id="textarea_load_input" cols="82" rows=5></textarea>
      <div class="load_explain">
      Copy and paste the contents from a previously saved session into this
      text box.
      </div>
      <button class="btn btn-dialog btn-primary" onclick="load_svg()">
      Load
      </button>
    </section>
    <section>
      <a name="upload"></a>
      <h2 class="load_h2">Upload file</h2>
      <div class="load_explain">
      This feature has not been implemented yet. If you would like it to exist,
      <span style="color:teal">tweet</span> "Hey @boardcrafting, please make
      file uploading
      work on http://1kfa.com/table ! #ttrpg #1kfa #featurerequest"
      <b>or</b> start participating with the development on Github
      </div>
    </section>
  </div>
  </div>
<!-- /LOAD ========================================================== /LOAD -->


<!-- BACKGROUND  =============================================== BACKGROUND -->
  <div class="modal" id="dialog_bg">
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_bg"
    >
      &#215;
    </button>
  <div class="modal-content">
    Use a URL as a background.  Examples:
    <ul>
      <li>http://www.1kfa.com/table/svg/bg_base_map.svg
      <li>http://www.1kfa.com/table/svg/bg_topography.svg
      <li>http://www.1kfa.com/table/svg/bg_hexagons.svg
      <li>https://images.ira.abramov.org/Propaganda/
    </ul>
    <label for="background_url">Enter a URL</label>
    <input id="background_url" type="url"
      value="http://www.1kfa.com/table/svg/bg_topography.svg"
    />
    <button id="dialog_bg_submit" onclick="ui_change_background(this)">
      Change Background URL
    </button>
  </div>
  </div>
<!-- /BACKGROUND ============================================== /BACKGROUND -->


<!-- PROPERTIES  =============================================== PROPERTIES -->

  <div class="modal" id="dialog_properties">
    <script>
function ui_popup_button(target) {
  var allSel = svg_table.select('[data-ui-marked]').members
  if (allSel.length !== 1) {
    alert('You must mark exactly 1 object to edit its properties');
    return
  }
  var el = allSel[0].node.firstChild;
  return ui_popup_properties(el, target)
}
function ui_popup_properties(el, dialog_specifier) {
  var submitButton = byId('dialog_properties_submit')
  var attrs = justNonUiAttributes(el)

  submitButton.addEventListener('click', (evt) => {
      var target = el

      if (is_marked(target)) {
        ui_unmark({target: target.parentNode.lastChild})
      }

      var inputs = document.getElementsByClassName('properties_input')
      Array.prototype.map.call(inputs, (input) => {
        var name = g(input, 'name')
        if (name) {
          console.log('setting', target, name, input.value)
          s(target, name, input.value);
        }
      });

      ui_popdown_dialog('dialog_properties')
      net_fire({ type: 'change', data: serialize(target) })
  });

  fieldset = byId('properties_fields')
  // first, clean up earlier messes
  var to_remove = []
  fieldset.childNodes.forEach((el) => {
    if (!el.classList || !el.classList.contains('template')) {
      to_remove.push(el)
    }
  });
  to_remove.map((el) => { el.remove() });

  inputTemplate = byId('properties_input_template')
  labelTemplate = byId('properties_label_template')
  Object.keys(attrs).map((key) => {
    input = inputTemplate.cloneNode(true)
    label = labelTemplate.cloneNode(false)
    s(label, 'id', 'properties_label_' + key)
    label.innerText = key;
    label.appendChild(input)
    s(input, 'name', key)
    s(input, 'id', 'properties_' + key)
    s(input, 'value', attrs[key])
    if (key.indexOf('data-') !== -1 ) {
      s(input, 'disabled', 'disabled')
    }
    input.classList.add('properties_input')
    input.classList.remove('template')
    label.classList.remove('template')
    fieldset.appendChild(label)
  })
  return ui_popup_dialog(dialog_specifier)
}
    </script>
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_properties"
    >
      &#215;
    </button>
  <div class="modal-content">
    <fieldset id="properties_fields">
    <label id="properties_label_template" class="template" >
      Template
      <input id="properties_input_template" class="template" type="text" value="x"/>
    </label>
    </fieldset>
    <br />
    <button id="dialog_properties_submit">
      Change
    </button>
  </div>
  </div>
<!-- /PROPERTIES  ============================================= /PROPERTIES -->


<!-- RECT =========================================================== RECT -->

  <div class="modal" id="dialog_rect">
    <script>

var rect_verbs = {
  'Mark': {
    applicable: (rectNode) => { return !is_marked(rectNode) },
    action: (evt, rectNode) => {
      return markElementById(rectNode.id)
    },
  },
  'Object properties': {
    applicable: () => { return true },
    action: (evt, rectNode) => {
      ui_popup_properties(
        rectNode,
        {'data-dialog-id': 'dialog_properties'}
      )
    }
  },
}

function make_rect(attrs) {
  var rect = svg_table.rect()
  rect.attr(Object.assign({
    'data-app-class': 'rect',
    'class': 'draggable',
    rx: 0,
    ry: 0,
    width: 100,
    height: 50,
    fill: 'cyan',
    stroke: 'black',
    'fill-opacity': 0.5,
    'stroke-opacity': 0.8,
    'stroke-width': 1,
  }, attrs))
  hookup_interactions(rect, rect_verbs)
  return rect;
}

function ui_submit_rect(evt) {
  w = parseInt(byId('rect_input_width').value);
  h = parseInt(byId('rect_input_height').value);
  if (!w || !h) {
    return;
  }
  var rect = make_rect({
    width: w,
    height: h,
    fill: getUserColor(),
  });
  ui_popdown_dialog('dialog_rect')
  net_fire({ type: 'create', data: serialize(rect) })
}

    </script>
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_rect"
    >
      &#215;
    </button>
  <div class="modal-content">
    <label for="rect_input_width">Width</label>
    <input id="rect_input_width" type="text" value="100"/>
    <br />
    <label for="rect_input_height">Height</label>
    <input id="rect_input_height" type="text" value="50"/>
    <br />
    <button id="dialog_submit" onclick="ui_submit_rect(this)"
      class="btn modal-close">
      Create
    </button>
  </div>
  </div>

<!-- END RECT =================================================== END RECT -->

<!-- CONTRIBUTE =============================================== CONTRIBUTE -->
  <div class="modal" id="dialog_contribute">
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_contribute"
    >
      &#215;
    </button>
    If you enjoy this tool, you can spread the love:
    <nav class="dialog_nav" id="contribute_nav">
    <div class="nav-wrapper">
      <ul class="left">
        <li><a href="#recognize">Give some recognition</a></li>
        <li><a href="#develop">Contribute to the codebase</a></li>
        <li><a href="#donate">Donate to related causes</a></li>
      </ul>
    </div>
    </nav>
  <div class="modal-content">
    <section>
      <a name="recognize"></a>
      <h2 class="contribute_h2">Give some recognition</h2>
      <div class="contribute_explain">
      If you do the whole social media thing:
      <a href="https://twitter.com/home?status=Thanks be to @boardcrafting for hosting https://www.1kfa.com/table !">By tweeting a tweet</a> or <a href="https://mastodon.social/">tooting a toot</a>.
      <p>
      If you've got a Github account, you can 
      <a href="https://github.com/sjbrown/1kfa">Star this project</a>
      </div>
    </section>
    <section>
      <a name="develop"></a>
      <h2 class="contribute_h2">Contribute to the codebase</h2>
      <div class="contribute_explain">
      Speaking of Github, you can
      <a href="https://github.com/sjbrown/1kfa">fork and contribute to this project</a>
      </div>
    </section>
    <section>
      <a name="donate"></a>
      <h2 class="contribute_h2">Donate</h2>
      <div class="contribute_explain">
      This is built on top of TogetherJS, a free, open-source project created by
      the Mozilla Foundation. They need money to continue making great software
      like this.
      <a href="https://donate.mozilla.org/en-US/">Donate to Mozilla here.</a>
      </div>
    </section>
  </div>
  </div>
<!-- /CONTRIBUTE ============================================== /CONTRIBUTE -->



  <menu type="context" id="gamemenu">
    <template id="template_menuitem">
      <menuitem label="X"
      ></menuitem>
    </template>
    <menuitem label="Delete marked objects"
     onclick="delete_marked(this)"
    ></menuitem>
  </menu>

</body>
</html>

