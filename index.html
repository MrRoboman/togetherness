<html>
<head>
<meta charset="utf-8">
<script src="https://togetherjs.com/togetherjs-min.js"></script>
<script src="./draggable.js"></script>
<script src="./come_together.js"></script>
<script src="./base32.js"></script>
<link rel="stylesheet" type="text/css" href="animate.css">
<style>
#gamearea {
  background-color: #efe;
  width: 80%;
  height: 80%;
  /*ddheight: 500px;
  */
}
.static {
  cursor: not-allowed;
}
.draggable, .draggable-group {
  cursor: move; /* fallback if grab is unsupported */
  cursor: grab;
}
.draggable:active, .draggable-group:active {
  cursor: grabbing;
}
dialog {
  max-width: 70%;
}
dialog label {
  display: block;
}
.template {
  display: none;
}


</style>

<script>

function randInt(min, max) {
  // get a random integer in the range, inclusive.
  // randInt(1,6) might return 1,2,3,4,5,6
  min = Math.ceil(min);
  max = Math.floor(max);
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function byId(id) {
  var rv = document.getElementById(id);
  if (!rv) {
    throw Error('element not found '+ id)
  }
  return rv;
}

function str_to_fn(fname) {
  // given a string, return a function
  return (
    (window[fname] && typeof window[fname] === 'function')
    ?  window[fname]
    : null
  );
}

function svgMap(parent, fn) {
  // iterate through an SVG element's children like [].map()
  var retval = [];
  parent.childNodes.forEach((el) => {
    if (g(el, 'data-app-class')) {
      var result = fn(el);
      if (result) {
        retval.push(result);
      }
    }
  });
  return retval;
}


togetherFunctions.on_hello = (msg) => {
  worldData = svgMap(get_world(), (el) => {
    return serializeSvg(el);
  });
  if (worldData.length) {
    fire({
      type: "sync",
      data: worldData,
      bg: byId('svgdoc').style.backgroundImage || null,
    });
  }
};

togetherFunctions.on_sync = (msg) => {
  world = get_world();
  msg.data.map(payload => {
    world.appendChild(deserialize(payload))
  });
  console.log('syncing bg', msg.bg)
  change_background(msg.bg);
};

togetherFunctions.on_change = (msg) => { deserialize(msg.data) };

togetherFunctions.on_create = (msg) => {
  get_world().appendChild(deserialize(msg.data));
};

togetherFunctions.on_create_mark = (msg) => {
  target = byId(msg.data.target.id);
  mark(target, msg.data.mark_rect)
};

togetherFunctions.on_drop_mark= (msg) => {
  _unmark(byId(msg.mark_rect.id));
};

togetherFunctions.on_delete = (msg) => {
  recursive_delete(msg.data);
};

togetherFunctions.on_change_background = (msg) => { change_background(msg.data) };

function deserialize(payload) {
  var el = null;
  if (document.getElementById(payload.id)) {
    // el is something that already exists in the local SVG doc
    el = byId(payload.id);
    Object.keys(payload).map(key => {
      if (isNaN(parseInt(key)) && key !== 'kids') {
        s(el, key, payload[key]);
      }
    });
  } else {
    // el is something new - remote has it, but it's not yet in the local doc
    var fn = str_to_fn('make_' + payload['data-app-class'])
    if (fn) {
      console.log('calling ', 'make_'+ payload['data-app-class'])
      el = fn(payload.id, payload);
    } else {
      throw Error('how to make? '+ payload['data-app-class'])
    }
  }
  if (payload.kids) {
    payload.kids.map(inner_payload => {
      var kid = deserialize(inner_payload);
      if (kid.parentNode) {
        kid.remove()
      }
      el.appendChild(deserialize(inner_payload));
    });
  }
  return el;
}

function recursive_delete(payload) {
  if (document.getElementById(payload.id)) {
    // el is something that already exists in the local SVG doc
    var el = byId(payload.id);
    el.remove();
  }
  if (payload.kids) {
    payload.kids.map(inner_payload => {
      recursive_delete(inner_payload);
    });
  }
}


function g(el, label) {
// getter - more natural "attributes" from SVG elements
  var get_fn = () => {
      if (el.dataset === undefined) {
        return el[label];
      }
      if (Object.keys(el.dataset).indexOf(label) != -1) {
        return el.dataset[label];
      }
      if (Object.keys(el.attributes).indexOf(label) != -1) {
        return el.getAttribute(label);
      }
      var value = el.getAttribute(label);
      if (value !== null) {
        return value;
      }
      if (label === 'width' || label === 'height') {
        return el.getBBox()[label];
      }
  };
  var retval = get_fn()
  if (retval === 'false' || retval === 'null' || retval === 'undefined') {
    throw Error(`Tried to set element attr to JS value? Something probably went wrong (${label})`);
  }
  return retval
}

function s(el, label, val) {
// getter - more natural "attributes" from SVG elements
  if (val === undefined || val === null) {
    console.log('rem', label, val)
    return el.removeAttribute(label);
  }
  el.setAttribute(label, val);
}

function getTranslation(el) {
  // Make sure the first transform on the element is a translate transform
  var transforms = el.transform.baseVal;

  if (transforms.length === 0 || transforms.getItem(0).type !== SVGTransform.SVG_TRANSFORM_TRANSLATE) {
    // Create an transform that translates by (0, 0)
    var translate = get_world().createSVGTransform();
    translate.setTranslate(0, 0);
    el.transform.baseVal.insertItemBefore(translate, 0);
  }
  return transforms.getItem(0);
}

function reduceNonUiAttributes(el) {
  return el.getAttributeNames()
  .reduce((acc,n) => {
    if (n.indexOf('data-ui-') === -1) {
      acc[n] = g(el, n);
    }
    return acc
  }, {});
}

function serialize_group(group) {
  var retval = reduceNonUiAttributes(group)
  retval.kids = [];
  svgMap(group, (el) => {
    retval.kids.push(serializeSvg(el));
  })
  return retval;
}

function serializeSvg(el) {
  if (!myClientId) {
    // no network connection - skip it
    return;
  }
  console.log('trying to serialize', el)
  var fn = str_to_fn('serialize_' + g(el, 'data-app-class'))
  if (fn) {
    return fn(el);
  }
  return reduceNonUiAttributes(el);
}

function move_to_center(el, target) {
  var el_transform = getTranslation(el);
  var target_transform = getTranslation(target)

  t_width = target.getBBox().width
  console.log('t bbox w', t_width)
  console.log('t bbox w', parseInt(t_width))
  half_t_width = parseInt(t_width)/2
  console.log('half t w', half_t_width)
  var a = parseInt(g(el, 'width'))/2
  console.log('a', a)
  var x = a - half_t_width;
  console.log('x', x)
  var centerize = [
    x,
    parseInt(g(el, 'height'))/2 - parseInt(target.getBBox().height) / 2,
  ];
  console.log('c', centerize)

  console.log('from matrix', el_transform.matrix)
  console.log('to matrix', target_transform.matrix)
  console.log('cenete', centerize)

  el_transform.setTranslate(
    el_transform.matrix.e + target_transform.matrix.e - centerize[0],
    el_transform.matrix.f + target_transform.matrix.f - centerize[1],
  );
}

function move_to(el, target) {
  // move the element to where the target is
  var el_transform = getTranslation(el);
  var target_transform = getTranslation(target)

  el_transform.setTranslate(
    el_transform.matrix.e + target_transform.matrix.e,
    el_transform.matrix.f + target_transform.matrix.f,
  );
}

function SVGElem(etype, id, attrs) {
  var el = document.createElementNS('http://www.w3.org/2000/svg', etype);
  s(el, 'id', id)
  Object.keys(attrs).map(key => {
    s(el, key, attrs[key])
  })
  return el;
}

function Rect(id, attrs) {
  return SVGElem('rect', id, Object.assign({
    x: 0,
    y: 0,
  }, attrs));
}


function make_group(id, attrs) {
  var validAttrs = Object.keys(attrs).reduce((acc, key) => {
    if (isNaN(parseInt(key)) && key !== 'kids') {
      acc[key] = attrs[key];
    }
    return acc;
  }, {});
  var group = SVGElem('g', id, Object.assign({
    'class': 'draggable-group',
    'data-app-class': 'group',
  }, validAttrs));
  return group;
}

function envelop(target, group_id) {
  //make the group
  var group = SVGElem('g', group_id, {
    'class': 'draggable-group',
    'data-app-class': 'group',
  });
  target.remove();
  group.appendChild(target);
  get_world().appendChild(group);
  return group;
}

function is_rect_marked(rect) {
  return (
    g(rect.parentNode, 'data-app-class') === 'group'
    &&
    g(rect.parentNode.lastChild, 'data-app-class') === 'mark'
  )
}

var rect_verbs = {
  'Mark': {
    test: (rect) => { return !is_rect_marked(rect) },
    action: (evt, rect) => {
      return rect_select({target: rect})
    },
  },
  'Object properties': {
    test: () => { return true },
    action: (evt, rect) => {
      ui_popup_properties(
        rect,
        {'data-dialog-id': 'dialog_properties'}
      )
    }
  },
}

var mark_verbs = {
  'Remove mark': {
    test: is_rect_marked,
    action: (evt, mark) => {
      console.log('r', mark);
      console.log('m', evt.target);
      return ui_unmark({target: mark})
    },
  },
  'Object properties': {
    test: () => { return true },
    action: (evt, mark) => {
      ui_popup_properties(
        mark.parentNode.firstChild,
        {'data-dialog-id': 'dialog_properties'}
      )
    }
  },
}

function ui_mouseover(evt, verbs) {
  console.log('hover', evt.target)

  deleteList = document.querySelectorAll('.cloned-menuitem')
  Array.prototype.forEach.call(deleteList, (el) => {
    el.remove();
  })

  var hover_rect = evt.target
  var menu = byId('gamemenu')
  var template = byId('template_menuitem')
  Object.keys(verbs).map((title) => {
    if (!verbs[title].test(hover_rect)) {
      return
    }
    var clone = template.content.firstElementChild.cloneNode(true)
    s(clone, 'id', 'menuitem-' + hover_rect.id)
    s(clone, 'label', title)
    clone.classList.add('cloned-menuitem')
    clone.addEventListener('click', (evt) => {
      console.log('x', hover_rect)
      return verbs[title].action(evt, hover_rect)
    })
    console.log('m', clone)
    menu.insertAdjacentElement('beforeend', clone)
  })
}

function ui_mouseout(evt) {
  console.log('hoveroff', evt.target)
}

function ui_unmark(evt) {
  mark_rect = evt.target;
  _unmark(mark_rect);

  ui_fire({type: 'dropMark', data: mark_rect.parentNode});
  fire({type: "dropMark", mark_rect: serializeSvg(mark_rect) });
}

function _unmark(mark_rect) {
  svg = get_world();
  group = byId('g' + mark_rect.id);

  svgMap(group, (target) => {
    target.remove()
    move_to(target, group)
    svg.appendChild(target);
  })

  mark_rect.remove()
  group.remove()
}

function make_mark(id, attrs) {
  var rect = Rect(
    (attrs && attrs.id) || 'mark' + base32.short_id(),
    Object.assign({
      'data-app-class': 'mark',
      x: -2,
      y: -2,
      fill: 'cyan',
      stroke: 'cyan',
      rx: 4,
      ry: 4,
      'fill-opacity': 0.1,
      'stroke-opacity': 0.8,
      'stroke-width': 1,
    }, attrs)
  )
  rect.addEventListener('dblclick', ui_unmark);
  rect.addEventListener('mouseover', (evt) => { ui_mouseover(evt, mark_verbs) });
  rect.addEventListener('mouseout', ui_mouseout)
  return rect
}

function mark(target, attrs) {
  // make the highlight rectangle
  var color = getUserColor();
  var rect = make_mark(
    (attrs && attrs.id) || 'mark' + base32.short_id(),
    Object.assign({
      'data-app-class': 'mark',
      width: parseInt(g(target, 'width')) + 4,
      height: parseInt(g(target, 'height')) + 4,
      fill: color,
      stroke: color,
      transform: g(target, 'transform'),
    }, attrs),
  )
  group = envelop(target, 'g' + rect.id)
  group.appendChild(rect);
  return {
    mark_rect: rect,
    highlight_group: group,
  }
}

function die_select(evt) {
  // evt.target might be the rect or the text node
  console.log('sel parent', evt.target.parentNode)
  console.log('sel elem', evt.target)
  group_target = evt.target.parentNode;

  var { mark_rect, highlight_group } = mark(group_target)

  ui_fire({ type: 'createMark', data: highlight_group })
  fire({type: "createMark", data: {
    mark_rect: serializeSvg(mark_rect),
    target: serializeSvg(group_target),
  }});
}

var die_verbs = {}
function make_die(id, attrs) {
  var die = Rect(id || 'die' + base32.short_id(), Object.assign({
    'data-app-class': 'die',
    rx: 20,
    ry: 20,
    width: 100,
    height: 100,
    //'class': 'draggable',
    fill: 'ivory',
    stroke: 'black',
    'fill-opacity': 1,
    'stroke-opacity': 0.8,
    'stroke-width': 5,
  }, attrs))
  die.addEventListener('dblclick', die_select)
  die.addEventListener('mouseover', (evt) => { ui_mouseover(evt, die_verbs) });
  die.addEventListener('mouseout', ui_mouseout)
  return die;
}

function Text(id, attrs) {
  textEl = SVGElem('text', id, Object.assign({
    'data-app-class': 'text',
    //'class': 'draggable',
    x: 0,
    y: 0,
    'fill': 'black',
    'fill-opacity': 1,
    'text-anchor': 'middle',
    'alignment-baseline': 'middle',
    'font-size': '30px',
  }, attrs));
  var tNode = document.createTextNode(attrs['data-text'] || 'foo');
  textEl.appendChild(tNode);
  return textEl;
}

function make_text(id, attrs) {
  var text = Text(id || 'text' + base32.short_id(), attrs);
  text.addEventListener('dblclick', die_select)
  text.addEventListener('mouseover', (evt) => { ui_mouseover(evt, text_verbs) });
  text.addEventListener('mouseout', ui_mouseout)
  return text
}

function do_animate(el, attrs) {
  var { ms, name } = Object.assign({
    ms: 900,
    name: 'slideInDown',
  }, attrs)
  el.classList.add('animated')
  el.classList.add(name)
  console.log('el', el)
  var timedFn;
  timedFn = setInterval(() => {
    el.classList.remove('animated')
    el.classList.remove(name)
    clearInterval(timedFn);
  }, ms);
}

function add_d6(e, target) {
  group = make_group('g' + base32.short_id(), {})
  get_world().appendChild(group);
  var die = make_die();
  group.appendChild(die)

  var txtEl = make_text('text' + base32.short_id(), {'data-text': randInt(1,6)})
  group.appendChild(txtEl);
  move_to_center(txtEl, die);

  do_animate(group)

  fire({type: "create", data: serializeSvg(group)});
}

function get_world() {
  return document.getElementsByTagName('svg')[0];
}

function initDraggable() {
  world = byId('svgdoc')
  makeDraggable(world, {
    endDragCb: (selectedElement) => {
      console.log('done drag', selectedElement)
      fire({type: "change", data: serializeSvg(selectedElement)});
    }
  });
}

function all_marked_groups() {
  return svgMap(get_world(), (el) => {
    if (g(el, 'data-ui-marked') === 'true') {
      return el;
    }
  })
}

function ui_update_buttons() {
  var allSel = all_marked_groups()

  var span = byId('num_selected')
  span.innerText = allSel.length;

  var btn = byId('delete_button')
  btn.disabled = (allSel.length === 0)

  btn = byId('properties_button')
  btn.disabled = (allSel.length !== 1)
}

function ui_fire(msg) {
  var fn = {
    createMark: (msg) => {
      s(msg.data, 'data-ui-marked', true)
      ui_update_buttons()
    },
    dropMark: (msg) => {
      console.log('ui drop sel')
      ui_update_buttons()
    },
    delete: (msg) => {
      console.log('ui delete sel')
      ui_update_buttons()
    },
  }[msg.type];

  if (fn) {
    fn(msg);
  } else {
    throw Error('Unknown msg type '+ msg.type);
  }
}

function animated_delete(el) {
  var ms = 900
  var animationClone = el.cloneNode(true)
  animationClone.id = 'clone' + Date.now()
  el.parentNode.insertBefore(animationClone, el)
  animationClone.getAttributeNames().map((n) => {
    if (n.indexOf('data-ui-') !== -1) {
      console.log('dropping', n)
      s(animationClone, n, null);
    }
  });
  s(animationClone, 'draggable-group', null);
  do_animate(animationClone, {name: 'rotateOut', ms: ms})
  var timedFn;
  timedFn = setInterval(() => {
    animationClone.remove();
    clearInterval(timedFn);
  }, ms);
}

function delete_selected(evt) {
  var allSel = all_marked_groups()
  var collection = make_group('deletegroup', {})
  allSel.map(el => {
    animated_delete(el)
    el.remove()
    collection.appendChild(el)
  })
  fire({ type: 'delete', data: serialize_group(collection) });
  ui_fire({type: 'delete', data: collection });
}

function ui_change_background(evt) {
  input = byId('background_url')
  if (!input.value) {
    return;
  }
  var value = "url('" + input.value + "')";
  change_background(value)
  ui_popdown_dialog({'data-dialog-id': 'dialog_bg'})
  fire({ type: 'change_background', data: value })
}

function change_background(value) {
  svg = byId('svgdoc')
  svg.style.backgroundImage = value
}

function ui_popdown_dialog(target) {
  s(byId(g(target, 'data-dialog-id')), 'open', null)
}

function ui_popup_dialog(target) {
  s(byId(g(target, 'data-dialog-id')), 'open', 'open')
}

</script>
</head>
<body>
<button onclick="TogetherJS(this); return false;">Start TogetherJS</button>
  <button onclick="add_d6(this)">
  Add d6
  </button>
  <button id="delete_button" onclick="delete_selected(this)"
    title="double-click objects to select and delete them"
    disabled="disabled"
  >
    Delete <span id="num_selected">0</span> Objects
  </button>

  <button id="bg_button" onclick="ui_popup_dialog(this)"
    data-dialog-id="dialog_bg">
    Change Background
  </button>

  <button id="draw_button" onclick="ui_popup_dialog(this)"
    data-dialog-id="dialog_rect">
    Draw rect
  </button>

  <button id="properties_button" onclick="ui_popup_button(this)"
    title="double-click objects to mark them"
    disabled="disabled"
    data-dialog-id="dialog_properties">
    Object Properties
  </button>

  <button id="save_button" onclick="ui_popup_dialog_save()"
    data-dialog-id="dialog_save">
    Save
  </button>


  <dialog id="dialog_save">
  <script>
function ui_popup_dialog_save() {
  textarea = byId('textarea_save_output')
  svg = byId('svgdoc')
  textarea.innerHTML = svg.outerHTML
  return ui_popup_dialog({'data-dialog-id': 'dialog_save'})
}
  </script>
    <button class="dialog_cancel" onclick="ui_popdown_dialog(this)"
      data-dialog-id="dialog_save"
    >
      &#215;
    </button>
    <nav id="save_nav">
      <a href="#copy_and_paste">Copy/Paste</a>
      <a href="#cloud">Cloud Storage</a>
    </nav>
    <section>
      <a name="copy_and_paste">
      <h1 class="save_h1">Copy and Paste</h1>
      <textarea id="textarea_save_output" cols="82" rows=20>X</textarea>
      <div class="save_explain">
      Copy and paste the contents of this text box to a file on your computer.
      </div>
    </section>
    <section>
      <a name="cloud">
      <h1 class="save_h1">Cloud Storage</h1>
      <div class="save_explain">
      This feature has not been implemented yet. If you would like it to exist,
      <span style="color:teal">tweet</span> "Hey @boardcrafting, please make Cloud Storage
      work on http://1kfa.com/table ! #ttrpg #1kfa #featurerequest"
      <b>or</b> start participating with the development on Github
      </div>
    </section>
  </dialog>

  <dialog id="dialog_bg">
    <button class="dialog_cancel" onclick="ui_popdown_dialog(this)"
      data-dialog-id="dialog_bg"
    >
      &#215;
    </button>
    <ul>
      <li>http://www.1kfa.com/table/base_map.svg
      <li>http://www.1kfa.com/table/topography.svg
      <li>http://www.1kfa.com/table/hexagons.svg
      <li>https://images.ira.abramov.org/Propaganda/
    </ul>
    <input id="background_url" type="url"
      value="http://www.1kfa.com/table/base_map.svg"
    />
    <button id="dialog_bg_submit" onclick="ui_change_background(this)">
      Change Background URL
    </button>
  </dialog>

  <dialog id="dialog_properties">
    <script>
function ui_popup_button(target) {
  var allSel = all_marked_groups()
  if (allSel.length !== 1) {
    alert('You must mark exactly 1 object to edit its properties');
    return
  }
  var el = allSel[0].firstChild;
  return ui_popup_properties(el, target)
}
function ui_popup_properties(el, dialog_specifier) {
  var submitButton = byId('dialog_properties_submit')
  var attrs = reduceNonUiAttributes(el)

  submitButton.addEventListener('click', (evt) => {
      var target = el

      if (is_rect_marked(target)) {
        ui_unmark({target: target.parentNode.lastChild})
      }

      var inputs = document.getElementsByClassName('properties_input')
      Array.prototype.map.call(inputs, (input) => {
        var name = g(input, 'name')
        if (name) {
          console.log('setting', target, name, input.value)
          s(target, name, input.value);
        }
      });

      ui_popdown_dialog({'data-dialog-id': 'dialog_properties'})
      fire({ type: 'change', data: serializeSvg(target) })
  });

  fieldset = byId('properties_fields')
  // first, clean up earlier messes
  var to_remove = []
  fieldset.childNodes.forEach((el) => {
    if (!el.classList || !el.classList.contains('template')) {
      to_remove.push(el)
    }
  });
  to_remove.map((el) => { el.remove() });

  inputTemplate = byId('properties_input_template')
  labelTemplate = byId('properties_label_template')
  Object.keys(attrs).map((key) => {
    input = inputTemplate.cloneNode(true)
    label = labelTemplate.cloneNode(false)
    s(label, 'id', 'properties_label_' + key)
    label.innerText = key;
    label.appendChild(input)
    s(input, 'name', key)
    s(input, 'id', 'properties_' + key)
    s(input, 'value', attrs[key])
    input.classList.add('properties_input')
    input.classList.remove('template')
    label.classList.remove('template')
    fieldset.appendChild(label)
  })
  return ui_popup_dialog(dialog_specifier)
}
    </script>
    <button class="dialog_cancel" onclick="ui_popdown_dialog(this)"
      data-dialog-id="dialog_properties"
    >
      &#215;
    </button>
    <br />
    <fieldset id="properties_fields">
    <label id="properties_label_template" class="template" >
      Template
      <input id="properties_input_template" class="template" type="text" value="x"/>
    </label>
    </fieldset>
    <br />
    <button id="dialog_properties_submit">
      Change
    </button>
  </dialog>

  <dialog id="dialog_rect">
    <script>
function make_rect(id, attrs) {
  var rect = Rect(id || 'rect' + base32.short_id(), Object.assign({
    'data-app-class': 'rect',
    'class': 'draggable',
    rx: 0,
    ry: 0,
    width: 100,
    height: 50,
    fill: 'cyan',
    stroke: 'black',
    'fill-opacity': 0.5,
    'stroke-opacity': 0.8,
    'stroke-width': 1,
  }, attrs))
  rect.addEventListener('dblclick', rect_select);
  rect.addEventListener('mouseover', (evt) => { ui_mouseover(evt, rect_verbs) });
  rect.addEventListener('mouseout', ui_mouseout);
  return rect;
}

function ui_submit_rect(evt) {
  w = parseInt(byId('rect_input_width').value);
  h = parseInt(byId('rect_input_height').value);
  if (!w || !h) {
    return;
  }
  var rect = make_rect('rect' + base32.short_id(), {
    width: w,
    height: h,
    fill: getUserColor(),
  });
  get_world().appendChild(rect);
  ui_popdown_dialog({'data-dialog-id': 'dialog_rect'})
  fire({ type: 'create', data: serializeSvg(rect) })
}

function rect_select(evt) {
  console.log('sel elem', evt.target)
  var target = evt.target;

  var { mark_rect, highlight_group } = mark(target)

  ui_fire({ type: 'createMark', data: highlight_group })
  fire({type: "createMark", data: {
    mark_rect: serializeSvg(mark_rect),
    target: serializeSvg(target),
  }});
}

    </script>
    <button class="dialog_cancel" onclick="ui_popdown_dialog(this)"
      data-dialog-id="dialog_rect"
    >
      &#215;
    </button>
    <br />
    <label for="rect_input_width">Width</label>
    <input id="rect_input_width" type="text" value="100"/>
    <br />
    <label for="rect_input_height">Height</label>
    <input id="rect_input_height" type="text" value="50"/>
    <br />
    <button id="dialog_submit" onclick="ui_submit_rect(this)">
      Create
    </button>
  </dialog>
  <dialog id="dialog_rect">
    <script>
function make_rect(id, attrs) {
  var rect = Rect(id || 'rect' + base32.short_id(), Object.assign({
    'data-app-class': 'rect',
    'class': 'draggable',
    rx: 0,
    ry: 0,
    width: 100,
    height: 50,
    fill: 'cyan',
    stroke: 'black',
    'fill-opacity': 0.5,
    'stroke-opacity': 0.8,
    'stroke-width': 1,
  }, attrs))
  rect.addEventListener('dblclick', rect_select);
  rect.addEventListener('mouseover', (evt) => { ui_mouseover(evt, rect_verbs) });
  rect.addEventListener('mouseout', ui_mouseout);
  return rect;
}

function ui_submit_rect(evt) {
  w = parseInt(byId('rect_input_width').value);
  h = parseInt(byId('rect_input_height').value);
  if (!w || !h) {
    return;
  }
  var rect = make_rect('rect' + base32.short_id(), {
    width: w,
    height: h,
    fill: getUserColor(),
  });
  get_world().appendChild(rect);
  ui_popdown_dialog({'data-dialog-id': 'dialog_rect'})
  fire({ type: 'create', data: serializeSvg(rect) })
}

function rect_select(evt) {
  console.log('sel elem', evt.target)
  var target = evt.target;

  var { mark_rect, highlight_group } = mark(target)

  ui_fire({ type: 'createMark', data: highlight_group })
  fire({type: "createMark", data: {
    mark_rect: serializeSvg(mark_rect),
    target: serializeSvg(target),
  }});
}

    </script>
    <button class="dialog_cancel" onclick="ui_popdown_dialog(this)"
      data-dialog-id="dialog_rect"
    >
      &#215;
    </button>
    <br />
    <label for="rect_input_width">Width</label>
    <input id="rect_input_width" type="text" value="100"/>
    <br />
    <label for="rect_input_height">Height</label>
    <input id="rect_input_height" type="text" value="50"/>
    <br />
    <button id="dialog_submit" onclick="ui_submit_rect(this)">
      Create
    </button>
  </dialog>

  <div id="gamearea" contextmenu="gamemenu">
  <svg id="svgdoc" width="100%" height="500" onload="initDraggable()">
  </svg>

  <menu type="context" id="gamemenu">
    <template id="template_menuitem">
      <menuitem label="X"
      ></menuitem>
    </template>
    <menuitem label="Delete selected objects"
     onclick="delete_selected(this)"
    ></menuitem>
  </menu>
  </div>

</body>
</html>

