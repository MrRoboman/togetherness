<html>
<head>
<meta charset="utf-8">

<script src="https://togetherjs.com/togetherjs-min.js"></script>
<script src="./svg_draggable.js"></script>
<script src="./come_together.js"></script>
<script src="./base32.js"></script>
<script src="./svg.js"></script>
<script src="./index.js"></script>

<link rel="stylesheet" type="text/css" href="animate.css">
<link rel="stylesheet" type="text/css" href="hiq.css">
<link rel="stylesheet" type="text/css" href="index.css">

<style>

</style>

</head>

<script>
var svgdoc;
SVG.on(document, 'DOMContentLoaded', () => {
  svgdoc = SVG('gamearea').size(600, 400)
  SVG.eid = (name) => {
    return name + '_' + base32.short_id()
  }
})
</script>

<body>
<button onclick="TogetherJS(this); return false;">Start TogetherJS</button>
  <button onclick="add_d6()">
  Add d6
  </button>
  <button id="delete_button" onclick="delete_marked(this)"
    title="double-click objects to mark and delete them"
    disabled="disabled"
  >
    Delete <span id="num_marked">0</span> Objects
  </button>

  <button id="bg_button" onclick="ui_popup_dialog(this)"
    data-dialog-id="dialog_bg">
    Change Background
  </button>

  <button id="draw_button" onclick="ui_popup_dialog(this)"
    data-dialog-id="dialog_rect">
    Draw rect
  </button>

  <button id="properties_button" onclick="ui_popup_button(this)"
    title="double-click objects to mark them"
    disabled="disabled"
    data-dialog-id="dialog_properties">
    Object Properties
  </button>

  <button id="save_button" onclick="ui_popup_dialog_save()"
    data-dialog-id="dialog_save">
    Save
  </button>

  <button id="load_button" onclick="ui_popup_dialog(this)"
    data-dialog-id="dialog_load">
    Load
  </button>

  <div id="gamearea" contextmenu="gamemenu">
  <!--
  <svg id="svgdoc" width="100%" height="500" onload="initDraggable()">
  </svg>
  -->
  </div>

<!-- SAVE ============================================================ SAVE -->
  <dialog id="dialog_save">
  <script>
function ui_popup_dialog_save() {
  textarea = byId('textarea_save_output')
  svg = byId('gamearea').querySelector('svg')
  textarea.innerHTML = svg.outerHTML
  return ui_popup_dialog({'data-dialog-id': 'dialog_save'})
}
  </script>
    <button class="dialog_cancel" onclick="ui_popdown_dialog(this)"
      data-dialog-id="dialog_save"
    >
      &#215;
    </button>
    <nav class="dialog_nav"  id="save_nav">
      <a href="#copy_and_paste">Copy/Paste</a>
      <a href="#cloud">Cloud Storage</a>
    </nav>
    <section>
      <a name="copy_and_paste"></a>
      <h1 class="save_h1">Copy and Paste</h1>
      <textarea id="textarea_save_output" cols="82" rows=10>X</textarea>
      <div class="save_explain">
      Copy and paste the contents of this text box to a file on your computer.
      </div>
    </section>
    <section>
      <a name="local"></a>
      <h1 class="save_h1">Local storage on your browser</h1>
      <div class="save_explain">
      This feature has not been implemented yet. If you would like it to exist,
      <span style="color:teal">tweet</span> "Hey @boardcrafting, please
      make Local Storage work on http://1kfa.com/table ! #ttrpg #1kfa
      #featurerequest"
      <b>or</b> start participating with the development on Github
      </div>
    </section>
    <section>
      <a name="cloud"></a>
      <h1 class="save_h1">Cloud Storage</h1>
      <div class="save_explain">
      This feature has not been implemented yet. If you would like it to exist,
      <span style="color:teal">tweet</span> "Hey @boardcrafting, please
      make Cloud Storage work on http://1kfa.com/table ! #ttrpg #1kfa
      #featurerequest"
      <b>or</b> start participating with the development on Github
      </div>
    </section>
  </dialog>
<!-- /SAVE ========================================================== /SAVE -->


<!-- LOAD ============================================================ LOAD -->
  <dialog id="dialog_load">
  <script>
function load_svg() {
  textarea = byId('textarea_load_input')
  svg = byId('gamearea').querySelector('svg')
  console.log('texar', textarea.value)
  svg.outerHTML = textarea.value
  ui_popdown_dialog({'data-dialog-id': 'dialog_load'})
}
  </script>
    <button class="dialog_cancel" onclick="ui_popdown_dialog(this)"
      data-dialog-id="dialog_load"
    >
      &#215;
    </button>
    <nav class="dialog_nav" id="load_nav">
      <a href="#copy_and_paste">Copy/Paste</a>
      <a href="#upload">Upload file</a>
    </nav>
    <section>
      <a name="copy_and_paste"></a>
      <h1 class="load_h1">Copy and Paste</h1>
      <textarea id="textarea_load_input" cols="82" rows=5></textarea>
      <div class="load_explain">
      Copy and paste the contents from a previously saved session into this
      text box.
      </div>
      <button class="btn btn-dialog btn-primary" onclick="load_svg()">
      Load
      </button>
    </section>
    <section>
      <a name="upload"></a>
      <h1 class="load_h1">Upload file</h1>
      <div class="load_explain">
      This feature has not been implemented yet. If you would like it to exist,
      <span style="color:teal">tweet</span> "Hey @boardcrafting, please make
      file uploading
      work on http://1kfa.com/table ! #ttrpg #1kfa #featurerequest"
      <b>or</b> start participating with the development on Github
      </div>
    </section>
  </dialog>
<!-- /LOAD ========================================================== /LOAD -->


<!-- BACKGROUND  =============================================== BACKGROUND -->
  <dialog id="dialog_bg">
    <button class="dialog_cancel" onclick="ui_popdown_dialog(this)"
      data-dialog-id="dialog_bg"
    >
      &#215;
    </button>
    <ul>
      <li>http://www.1kfa.com/table/svg/bg_base_map.svg
      <li>http://www.1kfa.com/table/svg/bg_topography.svg
      <li>http://www.1kfa.com/table/svg/bg_hexagons.svg
      <li>https://images.ira.abramov.org/Propaganda/
    </ul>
    <input id="background_url" type="url"
      value="http://www.1kfa.com/table/svg/topography.svg"
    />
    <button id="dialog_bg_submit" onclick="ui_change_background(this)">
      Change Background URL
    </button>
  </dialog>
<!-- /BACKGROUND ============================================== /BACKGROUND -->


<!-- PROPERTIES  =============================================== PROPERTIES -->

  <dialog id="dialog_properties">
    <script>
function ui_popup_button(target) {
  var allSel = svgdoc.select('[data-ui-marked]').members
  if (allSel.length !== 1) {
    alert('You must mark exactly 1 object to edit its properties');
    return
  }
  var el = allSel[0].node.firstChild;
  return ui_popup_properties(el, target)
}
function ui_popup_properties(el, dialog_specifier) {
  var submitButton = byId('dialog_properties_submit')
  var attrs = justNonUiAttributes(el)

  submitButton.addEventListener('click', (evt) => {
      var target = el

      if (is_marked(target)) {
        ui_unmark({target: target.parentNode.lastChild})
      }

      var inputs = document.getElementsByClassName('properties_input')
      Array.prototype.map.call(inputs, (input) => {
        var name = g(input, 'name')
        if (name) {
          console.log('setting', target, name, input.value)
          s(target, name, input.value);
        }
      });

      ui_popdown_dialog({'data-dialog-id': 'dialog_properties'})
      fire({ type: 'change', data: serialize(target) })
  });

  fieldset = byId('properties_fields')
  // first, clean up earlier messes
  var to_remove = []
  fieldset.childNodes.forEach((el) => {
    if (!el.classList || !el.classList.contains('template')) {
      to_remove.push(el)
    }
  });
  to_remove.map((el) => { el.remove() });

  inputTemplate = byId('properties_input_template')
  labelTemplate = byId('properties_label_template')
  Object.keys(attrs).map((key) => {
    input = inputTemplate.cloneNode(true)
    label = labelTemplate.cloneNode(false)
    s(label, 'id', 'properties_label_' + key)
    label.innerText = key;
    label.appendChild(input)
    s(input, 'name', key)
    s(input, 'id', 'properties_' + key)
    s(input, 'value', attrs[key])
    if (key.indexOf('data-') !== -1 ) {
      s(input, 'disabled', 'disabled')
    }
    input.classList.add('properties_input')
    input.classList.remove('template')
    label.classList.remove('template')
    fieldset.appendChild(label)
  })
  return ui_popup_dialog(dialog_specifier)
}
    </script>
    <button class="dialog_cancel" onclick="ui_popdown_dialog(this)"
      data-dialog-id="dialog_properties"
    >
      &#215;
    </button>
    <br />
    <fieldset id="properties_fields">
    <label id="properties_label_template" class="template" >
      Template
      <input id="properties_input_template" class="template" type="text" value="x"/>
    </label>
    </fieldset>
    <br />
    <button id="dialog_properties_submit">
      Change
    </button>
  </dialog>
<!-- /PROPERTIES  ============================================= /PROPERTIES -->


<!-- RECT =========================================================== RECT -->

  <dialog id="dialog_rect">
    <script>

var rect_verbs = {
  'Mark': {
    test: (rectNode) => { return !is_marked(rectNode) },
    action: (evt, rectNode) => {
      return markElementById(rectNode.id)
    },
  },
  'Object properties': {
    test: () => { return true },
    action: (evt, rectNode) => {
      ui_popup_properties(
        rectNode,
        {'data-dialog-id': 'dialog_properties'}
      )
    }
  },
}

function make_rect(attrs) {
  var rect = svgdoc.rect()
  rect.attr(Object.assign({
    'data-app-class': 'rect',
    'class': 'draggable',
    rx: 0,
    ry: 0,
    width: 100,
    height: 50,
    fill: 'cyan',
    stroke: 'black',
    'fill-opacity': 0.5,
    'stroke-opacity': 0.8,
    'stroke-width': 1,
  }, attrs))
  hookup_interactions(rect, rect_verbs)
  return rect;
}

function ui_submit_rect(evt) {
  w = parseInt(byId('rect_input_width').value);
  h = parseInt(byId('rect_input_height').value);
  if (!w || !h) {
    return;
  }
  var rect = make_rect({
    width: w,
    height: h,
    fill: getUserColor(),
  });
  ui_popdown_dialog({'data-dialog-id': 'dialog_rect'})
  fire({ type: 'create', data: serialize(rect) })
}

    </script>
    <button class="dialog_cancel" onclick="ui_popdown_dialog(this)"
      data-dialog-id="dialog_rect"
    >
      &#215;
    </button>
    <br />
    <label for="rect_input_width">Width</label>
    <input id="rect_input_width" type="text" value="100"/>
    <br />
    <label for="rect_input_height">Height</label>
    <input id="rect_input_height" type="text" value="50"/>
    <br />
    <button id="dialog_submit" onclick="ui_submit_rect(this)">
      Create
    </button>
  </dialog>

<!-- END RECT =================================================== END RECT -->



  <menu type="context" id="gamemenu">
    <template id="template_menuitem">
      <menuitem label="X"
      ></menuitem>
    </template>
    <menuitem label="Delete marked objects"
     onclick="delete_marked(this)"
    ></menuitem>
  </menu>

</body>
</html>

