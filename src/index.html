<html>
<head>
<title>Togetherness Table</title>
<meta charset="utf-8">

<!--
 The SVG viewport is the scrolling / panning / zooming area, so
 prevent touch events from zooming into the page
 ( from https://www.html5rocks.com/en/mobile/touchandmouse/ )
-->
<meta name="viewport" content="width=device-width,user-scalable=no">

<script>
/*
 *
 * Configure TogetherJS
 *
 */
TogetherJSConfig_hubBase = "https://togetherjs-hub.glitch.me/"
TogetherJSConfig_siteName = "table"
TogetherJSConfig_toolName = "Multiplayer"
//TogetherJSConfig_cloneClicks = "foo"; // This might be useful, or not
//TogetherJSConfig_dontShowClicks = "foo";
//TogetherJSConfig_enableShortcut = "foo";
TogetherJSConfig_suppressJoinConfirmation = true
TogetherJSConfig_suppressInvite = true
TogetherJSConfig_includeHashInUrl = true
TogetherJSConfig_disableWebRTC = true
// Hack: to get stable Share URLs
TogetherJSConfig_findRoom = 'abcd1234i'
// Hack: I had to look into the TogetherJS source code for this one.
localStorage.setItem('togetherjs.settings.seenIntroDialog', true)


TogetherJSConfig_on_ready = () => {
  el = document.getElementById('share_url')
  el.value = TogetherJS.shareUrl()
  el = document.getElementById('share_url_bar')
  el.classList.remove('inactive')
  el.classList.add('active')
  el.classList.remove('whitebg')
  el.classList.add('bluebg')
}
TogetherJSConfig_on_close = () => {
  el = document.getElementById('share_url')
  el.value = ''
  el = document.getElementById('share_url_bar')
  el.classList.remove('active')
  el.classList.add('inactive')
  el.classList.remove('bluebg')
  el.classList.add('whitebg')
}
</script>
<script src="https://togetherjs.com/togetherjs-min.js"></script>
<script src="./svg_draggable.js"></script>
<script src="./come_together.js"></script>
<script src="./base32.js"></script>
<script src="./svg.js"></script>
<script src="./index.js"></script>
<script src="./js/domJSON.js"></script>

<link rel="stylesheet" type="text/css" href="animate.css">
<link rel="stylesheet" type="text/css" href="index.css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>


</head>

<script>
var svg_table;
var viewport;
var gViewport;
var widget_panzoom;

function initSvgTable(el) {
/*
  oldTable = gViewport.node.querySelector('#svg_table')
  if (oldTable) {
    console.log('found old table', oldTable)
    svg_table.remove()
  }
  */
  el.id = 'svg_table'
  svg_table = SVG.adopt(el)
  svg_table.size(1000, 480)
  gViewport.add(svg_table)
  makeDraggable(svg_table)
  return svg_table
}

SVG.on(document, 'DOMContentLoaded', () => {
  // Override the id-generating function of the svg.js library
  SVG.eid = (name) => {
    return name + '_' + base32.short_id()
  }

  viewport = SVG('gamearea').size(500, 480)
  viewport.node.id = 'svg_viewport'
  s(viewport.node, 'width', '100%')
  viewport.style('background-image', 'url(svg/bg_hexagons.svg)')
  viewport.node.onclick = (e) => {
    if (e.target.id === viewport.node.id) {
      ui_unmark_all_but()
    }
  }

  gViewport = SVG.adopt(document.createElementNS(SVG.ns, 'g'))
  gViewport.node.id = 'g_viewport'
  viewport.add(gViewport)

  initSvgTable(document.createElementNS(SVG.ns, 'svg'))
  table_rect = gViewport.rect()
  table_rect.attr({
     x: -1,
     y: -1,
     rx: 0,
     ry: 0,
     width: 1002,
     height: 482,
     fill: 'none',
     stroke: 'black',
     'stroke-width': 10,
     'stroke-opacity': 0.1,
  })

  document.addEventListener('svg_dragend', (evt) => {
    selectedElement = byId(evt.detail.elemId)
    net_fire({type: "change", data: serialize(selectedElement)})
  })

  widgetElem = document.querySelector('#widget_panzoom')
  widgetElem.addEventListener('load', () => {
    let widgetElem = document.querySelector('#widget_panzoom')
    // TODO -----------------------------------------
    // Some browsers can't do getSVGDocument(), so just
    // hide the panzoom widget
    // TODO -----------------------------------------
    let svgDom = widgetElem.getSVGDocument()
    if (svgDom == null) {
      widgetElem.remove()
      return
    }
    widget_panzoom = svgDom.querySelector('svg');
    widget_panzoom = SVG.adopt(widget_panzoom)
    viewport.add(widget_panzoom)
    widget_panzoom.x(0)
    widget_panzoom.y( viewport.height() - widget_panzoom.height() )
    widget_panzoom.select('#x_left').on('click', () => pan(50, 0))
    widget_panzoom.select('#x_right').on('click', () => pan(-50, 0))
    widget_panzoom.select('#y_up').on('click', () => pan(0, 50))
    widget_panzoom.select('#y_down').on('click', () => pan(0, -50))
    widget_panzoom.select('#zoom_in').on('click', () => zoom('in'))
    widget_panzoom.select('#zoom_out').on('click', () => zoom('out'))
    widgetElem.remove()
  });

  // Initialize modals
  instances = M.Modal.init(document.querySelectorAll('.modal'), {
    opacity: 0.75,
  });
})

function pan(xDelta, yDelta) {
  prev = gViewport.transform()
  gViewport.transform( {x: prev.x + xDelta, y: prev.y + yDelta} )
}

var currentZoom = 1.0;
function zoom(inOrOut) {
  zooms = {
    0.25: { out: 0.25, in: 0.50 },
    0.50: { out: 0.25, in: 0.75 },
    0.75: { out: 0.50, in: 1.0 },
    1.0: { out: 0.75, in: 1.5 },
    1.5: { out: 1.0, in: 2.0 },
    2.0: { out: 1.5, in: 4.0 },
    4.0: { out: 2.0, in: 4.0 },
  }
  currentZoom = zooms[currentZoom][inOrOut];
  gViewport.transform( {scale: currentZoom} )
}

function updateColorSample(target) {
  el = target.parentNode.querySelector('#colorsample')
  el.style.setProperty('border', 'solid thin black')
  el.style.setProperty('color', target.value)
}

function downKey(e) {
  if (e.target.tagName.toLowerCase() !== 'body') { return }
  if (e.altKey || e.shiftKey || e.metaKey || e.ctrlKey) { return }
  button = null
  document.querySelectorAll('button').forEach((x) => {
    if (button && x.accessKey === e.key) {
      console.error('Two buttons have the same accessKey', x.accessKey)
      return
    }
    if (x.accessKey === e.key) {
      button = x
    }
  })
  if (button) {
    button.click()
  }
}

window.addEventListener('load', () => {
  document.querySelector('body').addEventListener('keydown', downKey)
})

</script>

<body>

<!-- ==================================================================== -->
<style>
.menu-left {
  max-width: 100px;
  display: inline-block;
}
</style>
<section class="menu menu-left buttongroup collapsegroup" id="buttongroup_table">
  <button id="dice_dialog_button" class="btn btn-small modal-trigger"
    accesskey="d"
    data-target="dialog_dice"
    data-dialog-id="dialog_dice">
    + <u>D</u>ice
  </button>

  <button class="btn btn-small" onclick="add_object('svg/v1/poker_deck.svg')">
  + Cards
  </button>
<!--
  <button class="btn" onclick="add_object('svg/v1/deckahedron.svg')">
  + Deckahedron
  </button>

  <button id="pbta_button" class="btn btn-small modal-trigger"
    onclick="add_object('svg/v1/pbta.svg')"
    >
    + pbta
  </button>
  -->
  <button id="clocks_dialog_button" class="btn btn-small modal-trigger"
    accesskey="k"
    data-target="dialog_clocks"
    data-dialog-id="dialog_clocks">
    + Cloc<u>k</u>s
  </button>

  <button id="other_button" class="btn btn-small modal-trigger"
    accesskey="o"
    data-target="dialog_other"
    data-dialog-id="dialog_other">
    + <u>O</u>ther
  </button>

</section>


<!-- ==================================================================== -->
<script>
window.addEventListener('load', () => {
  document.querySelector('.player_menu_button_large')
  .addEventListener('click', (e) => {
      cgroup = e.target.closest('.collapsegroup')
      cgroup.classList.toggle('active')
      if (cgroup.classList.contains('initial')) {
        cgroup.classList.remove('initial')
      }
      cgroup.classList.toggle('collapsed')
  })
  document.querySelector('.player_menu_button_mobile')
  .addEventListener('click', (e) => {
      cgroup = e.target.closest('.collapsegroup')
      cgroup.classList.toggle('active')
      if (cgroup.classList.contains('initial')) {
        cgroup.classList.remove('initial')
      } else {
        cgroup.classList.toggle('collapsed')
      }
  })
})
</script>
<style>
.menu {
  position: fixed;
  top: 0px;
}
.menu button {
  width: 100%;
}
.menu-right {
  max-width: 150px;
  display: inline-block;
  right: 0%;
}
@media only screen and (max-width: 900px) {
  .menu {
    top: auto;
    bottom: 0;
  }
  .menu-right {
    left: auto;
    right: 0;
  }
}

.menu .player_menu_button_mobile {
display: none;
}
.collapsegroup > .collapsible {
  overflow: hidden;
  transition: max-height 0.2s ease-out;
  margin: 0px;
}
.initial > .collapsible {
  max-height: 1000px;
}
.collapsed > .collapsible {
  max-height: 0px;
  margin: 0px;
}
.collapsetoggle:after {
  content:" ▾";
}
.collapsed > .collapsetoggle:after {
  content:" ☰";
}

@media only screen and (max-width: 900px) {
  .initial > .collapsible {
    max-height: 0px;
  }
  .initial > .collapsetoggle:after {
    content:" ☰";
  }
  .menu .player_menu_button_large {
    display: none;
    border: red;
  }
  .menu .player_menu_button_mobile {
    display: block;
  }
}


</style>
<section class="menu menu-right buttongroup collapsegroup initial" id="buttongroup_player">
<button class="player_menu_button_large collapsetoggle btn" name="playermenu" >Player</button>
<button class="player_menu_button_mobile collapsetoggle btn mobile" name="playermenu" >Player</button>
<div class="collapsible">

<!--
  <button id="properties_button" class="btn btn-small"
    onclick="ui_popup_button()"
    title="double-click objects to mark them"
    disabled="disabled"
    data-target="dialog_properties"
    data-dialog-id="dialog_properties">
    Properties
  </button>
  -->

  <button id="bg_button" class="btn btn-small modal-trigger"
    title="Change Background"
    data-target="dialog_bg"
    data-dialog-id="dialog_bg">
    Change BG
  </button>

  <button id="save_button" class="btn btn-small"
    onclick="ui_popup_dialog_save()"
    data-dialog-id="dialog_save">
    Save
  </button>

  <button id="load_button" class="btn btn-small modal-trigger"
    data-target="dialog_load"
    data-dialog-id="dialog_load">
    Load
  </button>

  <button id="help_button" class="btn btn-small modal-trigger"
    title="Help this project"
    data-target="dialog_contribute"
    data-dialog-id="dialog_contribute">
    Help this project
  </button>

  <button class="btn btn-small" onclick="TogetherJS(this); return false;"
    title="Invite / Join Friends"
    id="start-togetherjs"
  >Multiplayer</button>

</div>
</section>


<!-- ==================================================================== -->
<!-- ==================================================================== -->
<style>
#gamearea {
  max-width: 800px;
}
</style>
<center>
  <div id="gamearea" contextmenu="gamemenu">
    <object id="widget_panzoom" data="svg/widget_panzoom.svg" type="image/svg+xml">
    </object>
  <!--
  <svg id="svgdoc" width="100%" height="500" onload="initDraggable()">
  </svg>
  -->
  </div>
</center>
<!-- ==================================================================== -->
<!-- ==================================================================== -->


<style>

#footer {
  min-width: 80%;
}
@media screen and (max-width: 1200px) {
  #footer {
    min-width: 100%;
  }
}


.footerbar.inactive {
  animation: slide-out 0.5s forwards;
  transform: translateY(1050%);
  visibility: collapse;
}

.footerbar {
  width: 100%;
  padding: 4px 10px;
  transition: background-color 2s;
  transition: transform 2s;
}

.graybg {
  background-color: #a0a0a0;
}

.bluebg {
  background-color: rgb(0, 149, 221);
}

.whitebg {
  background-color: #f0f0f0;
}

.footerbar h3 {
  display: inline;
}

</style>
  <div id="footer">
    <!-- =============OBJECT ACTIONS ==================== -->
    <div id="object_actions" class="footerbar graybg">
    <script>
    window.addEventListener('load', () => {
      document.querySelector('#object_actions_header.mobile')
      .addEventListener('click', (e) => {
        e.target.style.setProperty('display', 'none')
      })
    })
    </script>
    <style>
    #object_actions_header {
      font-size: larger;
      margin-right: 40px;
    }
    #object_actions_header.mobile {
      display: none;
    }
    @media only screen and (max-width: 900px) {
      #object_actions {
        position: fixed;
        top: 20%;
        left: 0;
        max-width: 200px;
        background-color: #00000000;
      }
      #object_actions .btn-large {
        min-width: 120px;
        height: 34px;
        line-height: 34px;
        font-size: 13px;
      }
      #object_actions_header {
        display: none;
      }
      #object_actions_header.mobile {
        display: inline;
      }
    }
    </style>
        <h3 id="object_actions_header">Select objects by clicking on them</h3>
        <h3 id="object_actions_header" class="mobile">Select objects by long-pressing on them</h3>
      <template id="template_object_actions">
        <button class="btn btn-large">Button label</button>
      </template>
    </div>
    <!-- =============SHARE URL BAR ==================== -->
    <div id="share_url_bar" class="inactive footerbar whitebg">
    <style>

     #share_url_bar td {
       padding: 0px;
       border-radius: 0px;
     }
     #share_url_bar tr {
       border: 0px;
     }
     #share_url_label {
       font-size: larger;
       margin-right: 40px;
     }
    </style>
      <table
      title="Share this URL with your friends and have them join you"
      >
      <tr>
      <td>
      <span id="share_url_label">Share URL:</span>
      </td>
      <td>
      <style>
      #share_url {
        font-family: monospace;
        display: inline-block;
        background-color: transparent;
        border: none;
        font-size: inherit;
        height: inherit;
        margin: inherit;

      }
      </style>
      <input id="share_url" value="" />
      </td>
      <td>
      <script>
      function copyURLToClipboard() {
        copyText = document.getElementById('share_url')
        /* Select the text field */
        copyText.select()
        copyText.setSelectionRange(0, 99999) /*For mobile devices*/
        document.execCommand("copy")
      }
      </script>
      <button id="share_url_copy_button" class="btn btn-small"
        onClick="copyURLToClipboard()"
      >Copy URL</button>
      </td>
      </tr>
      </table>
    </div>
  </div>

<!-- SAVE ============================================================ SAVE -->
  <div id="dialog_save" class="modal">
  <script>
function ui_popup_dialog_save() {
  textarea = byId('textarea_save_output')
  svg = byId('svg_table').cloneNode(true)
  svg.querySelectorAll('svg').forEach((subSvg) => {
    // Unset the state that ties the element to this active document
    /* This has a bug right now...
    Object.keys(subSvg.dataset).map((dataKey) => {
      console.log('lookat', dataKey)
      if (dataKey.slice(0,2) === 'ui') {
        console.log('dropping', dataKey, 'in', subSvg.id)
        delete subSvg.dataset[dataKey]
      }
    })
    */
    s(subSvg, 'data-ui-initialized', null)
  })
  textarea.innerHTML = svg.outerHTML
  svg.remove()
  return ui_popup_dialog({'data-dialog-id': 'dialog_save'})
}
  </script>
    <button class="btn dialog_cancel modal-close">
      &#215;
    </button>
    <nav class="dialog_nav"  id="save_nav">
    <div class="nav-wrapper">
      <ul class="left">
        <li><a href="#copy_and_paste">Copy/Paste</a></li>
        <li><a href="#local">Local storage</a></li>
        <li><a href="#cloud">Cloud storage</a></li>
      </ul>
    </div>
    </nav>
  <div class="modal-content">
    <section>
      <a name="copy_and_paste"></a>
      <h2 class="save_h2">Copy and Paste</h2>
      <textarea id="textarea_save_output" cols="82" rows=10>X</textarea>
      <div class="save_explain">
      Copy and paste the contents of this text box to a file on your computer.
      </div>
    </section>
    <section>
      <a name="local"></a>
      <h2 class="save_h2">Local storage on your browser</h2>
      <div class="save_explain">
      This feature has not been implemented yet. If you would like it to exist,
      <span style="color:teal">tweet</span> "Hey @boardcrafting, please
      make Local Storage work on http://1kfa.com/table ! #ttrpg #1kfa
      #featurerequest"
      <b>or</b> start participating with the development on Github
      </div>
    </section>
    <section>
      <a name="cloud"></a>
      <h2 class="save_h2">Cloud storage</h2>
      <div class="save_explain">
      This feature has not been implemented yet. If you would like it to exist,
      <span style="color:teal">tweet</span> "Hey @boardcrafting, please
      make Cloud Storage work on http://1kfa.com/table ! #ttrpg #1kfa
      #featurerequest"
      <b>or</b> start participating with the development on Github
      </div>
    </section>
  </div>
  </div>
<!-- /SAVE ========================================================== /SAVE -->


<!-- LOAD ============================================================ LOAD -->
  <div id="dialog_load" class="modal">
  <script>
function load_svg() {
  textarea = byId('textarea_load_input')
  svg = byId('svg_table')
  svg.outerHTML = textarea.value
  initSvgTable(svg)
  svg = byId('svg_table')
  svg.querySelectorAll('[data-app-class] script').forEach((script) => {
    subSvg = script.parentNode
    console.log("appending script", script)
    appendDocumentScript(script, subSvg)
  })
  svg.querySelectorAll('[data-app-class]').forEach((subSvg) => {
    hookup_ui(subSvg)
    hookup_foreign_scripts(subSvg)
  })
  svg.querySelectorAll('[data-nest-for=mark]').forEach((subSvg) => {
    hookup_mark_handlers(subSvg)
  })

  return ui_popdown_dialog('dialog_load')
}
  </script>
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_load"
    >
      &#215;
    </button>
    <nav class="dialog_nav" id="load_nav">
    <div class="nav-wrapper">
      <ul class="left">
        <li><a href="#copy_and_paste">Copy/Paste</a></li>
        <li><a href="#upload">Upload file</a></li>
      </ul>
    </div>
    </nav>
  <div class="modal-content">
    <section>
      <a name="copy_and_paste"></a>
      <h2 class="load_h2">Copy and Paste</h2>
      <textarea id="textarea_load_input" cols="82" rows=5></textarea>
      <div class="load_explain">
      Copy and paste the contents from a previously saved session into this
      text box.
      </div>
      <button class="btn btn-dialog btn-primary" onclick="load_svg()">
      Load
      </button>
    </section>
    <section>
      <a name="upload"></a>
      <h2 class="load_h2">Upload file</h2>
      <div class="load_explain">
      This feature has not been implemented yet. If you would like it to exist,
      <span style="color:teal">tweet</span> "Hey @boardcrafting, please make
      file uploading
      work on http://1kfa.com/table ! #ttrpg #1kfa #featurerequest"
      <b>or</b> start participating with the development on Github
      </div>
    </section>
  </div>
  </div>
<!-- /LOAD ========================================================== /LOAD -->


<!-- BACKGROUND  =============================================== BACKGROUND -->
  <div class="modal" id="dialog_bg">
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_bg"
    >
      &#215;
    </button>
  <div class="modal-content">
    Use a URL as a background.  Examples:
    <ul>
      <li>http://www.1kfa.com/table/svg/bg_topography.svg
      <li>http://www.1kfa.com/table/svg/bg_hexagons.svg
    </ul>
    <label for="background_url">Enter a URL</label>
    <input id="background_url" type="url"
      value="http://www.1kfa.com/table/svg/bg_topography.svg"
    />
    <button class="btn" id="dialog_bg_submit"
      onclick="ui_change_background(this)">
      Change Background URL
    </button>
  </div>
  </div>
<!-- /BACKGROUND ============================================== /BACKGROUND -->


<!-- PROPERTIES  =============================================== PROPERTIES -->

  <div class="modal" id="dialog_properties">
    <script>
function ui_popup_button() {
  var allSel = svg_table.select('[data-ui-marked]').members
  if (allSel.length !== 1) {
    alert('You must mark exactly 1 object to edit its properties');
    return
  }
  var el = allSel[0].node.firstChild;
      console.log('ui popup handler')
  return ui_popup_properties(el, {'data-dialog-id': 'dialog_properties'})
}

function ui_popup_properties(el, dialog_specifier) {
  var submitButton = byId('dialog_properties_submit')
  var attrs = justNonUiAttributes(el)

  submitButton.addEventListener('click', (evt) => {
      var target = el

      if (is_marked(target)) {
        ui_unmark({target: target.parentNode.lastChild})
      }

      var inputs = document.getElementsByClassName('properties_input')
      Array.prototype.map.call(inputs, (input) => {
        var name = g(input, 'name')
        if (name) {
          console.log('setting', target, name, input.value)
          s(target, name, input.value);
        }
      });

      ui_popdown_dialog('dialog_properties')
      net_fire({ type: 'change', data: serialize(target) })
  });

  fieldset = byId('properties_fields')
  // first, clean up earlier messes
  var to_remove = []
  fieldset.childNodes.forEach((el) => {
    if (!el.classList || !el.classList.contains('template')) {
      to_remove.push(el)
    }
  });
  to_remove.map((el) => { el.remove() });

  inputTemplate = byId('properties_input_template')
  labelTemplate = byId('properties_label_template')
  Object.keys(attrs).map((key) => {
    input = inputTemplate.cloneNode(true)
    label = labelTemplate.cloneNode(false)
    s(label, 'id', 'properties_label_' + key)
    label.innerText = key;
    label.appendChild(input)
    s(input, 'name', key)
    s(input, 'id', 'properties_' + key)
    s(input, 'value', attrs[key])
    if (key.indexOf('data-') !== -1 ) {
      s(input, 'disabled', 'disabled')
    }
    input.classList.add('properties_input')
    input.classList.remove('template')
    label.classList.remove('template')
    fieldset.appendChild(label)
  })
  return ui_popup_dialog(dialog_specifier)
}
    </script>
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_properties"
    >
      &#215;
    </button>
  <div class="modal-content">
    <fieldset id="properties_fields">
    <label id="properties_label_template" class="template" >
      Template
      <input id="properties_input_template" class="template" type="text" value="x"/>
    </label>
    </fieldset>
    <br />
    <button id="dialog_properties_submit">
      Change
    </button>
  </div>
  </div>
<!-- /PROPERTIES  ============================================= /PROPERTIES -->


<!-- DIALOG_DICE ============================================= DIALOG_DICE -->

  <div class="modal" id="dialog_dice">
  <style>
  @media only screen and (max-width: 900px) {
    .modal table .btn {
      padding: 0px;
    }
  }
  .dice_section {
    margin-bottom: 80px;
  }
  </style>
    <script>

function add_dtype(dtype, inputEl, center, serializedState) {
  console.log('add_dtype', dtype, inputEl.id, center, serializedState)
  num = parseInt(inputEl.value) || 0
  console.log('num', num)
  for( var i=0; i < num; i++ ) {
    add_object(
      'svg/v1/dice_' + dtype +'.svg',
      {
        // Wrap 'center' in a new array to avoid async bugs
        'center': [center[0], center[1]],
        'serializedState': serializedState,
      },
    )
    center[0] = center[0] + 90
    center[1] = center[1] + 10
  }
  inputEl.value = 0
}

function diceIncrement(dtype) {
  el = byId('dice_input_' + dtype)
  num = parseInt(el.value) || 0
  el.value = num + 1
  return true
}

function ui_submit_dice(section) {
  console.log('submit', section)
  center = [50, 50]
  if (section === 'sw') {
    dtypes = ['sw_d61', 'sw_d62', 'sw_d81', 'sw_d82', 'sw_d121', 'sw_d122', 'sw_d123']
    dtypes.forEach((dtype) => {
      add_dtype(dtype, byId('dice_input_' + dtype), center)
    })
  } else if (section === 'fudge') {
    dtypes = ['fudge_d6',]
    dtypes.forEach((dtype) => {
      add_dtype(dtype, byId('dice_input_' + dtype), center)
    })
  } else if (section === 'special') {
    add_dtype(
      'dn', byId('dice_input_dn'), center,
      {
        numFaces: byId('dice_input_dn_num_faces').value
      }
    )
    add_dtype(
      'dsymbol', byId('dice_input_dsymbol'), center,
      {
        faces: byId('dice_input_dsymbol_faces').value
      }
    )
  } else {
    dtypes = ['d4', 'd6', 'd8', 'd10', 'd12', 'd20']
    dtypes.forEach((dtype) => {
      add_dtype(dtype, byId('dice_input_' + dtype), center)
    })
  }
  ui_popdown_dialog('dialog_dice')
}

    </script>
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_dice"
    >
      &#215;
    </button>
    <nav class="dialog_nav" id="dialog_dice_nav">
    <div class="nav-wrapper">
      <ul class="left">
        <li><a href="#standard">Standard Dice</a></li>
        <li><a href="#sw">SW / Genesys Dice</a></li>
        <li><a href="#fudge">FUDGE Dice</a></li>
        <li><a href="#special">Special Dice</a></li>
      </ul>
    </div>
    </nav>
  <div class="modal-content">
    <section class="dice_section" id="standard_dice_section">
      <a name="standard"></a>
      <h2 id="standard_dice_h2">Standard Dice</h2>
      <!--
      <label for="dice_text_input">Add dice via text specification</label>
      <input id="dice_text_input" type="text" placeholder="1d10, 2d20"/>
      -->
      <table><tr>
      <td>
        <input id="dice_input_d4" type="text" value="0"/>
        <button class="btn" id="dice_button_d4" onclick="diceIncrement('d4')">
          <img src="svg/v1/dice_d4.svg" width="24" height="24" />
        </button>
      </td>
      <td>
        <input id="dice_input_d6" type="text" value="1"/>
        <button class="btn" id="dice_button_d6" onclick="diceIncrement('d6')">
          <img src="svg/v1/dice_d6.svg" width="24" height="24" />
        </button>
      </td>
      <td>
        <input id="dice_input_d8" type="text" value="0"/>
        <button class="btn" id="dice_button_d8" onclick="diceIncrement('d8')">
          <img src="svg/v1/dice_d8.svg" width="24" height="24" />
        </button>
      </td>
      <td>
        <input id="dice_input_d10" type="text" value="0"/>
        <button class="btn" id="dice_button_d10" onclick="diceIncrement('d10')">
          <img src="svg/v1/dice_d10.svg" width="24" height="24" />
        </button>
      </td>
      <td>
        <input id="dice_input_d12" type="text" value="0"/>
        <button class="btn" id="dice_button_d12" onclick="diceIncrement('d12')">
          <img src="svg/v1/dice_d12.svg" width="24" height="24" />
        </button>
      </td>
      <td>
        <input id="dice_input_d20" type="text" value="0"/>
        <button class="btn" id="dice_button_d20" onclick="diceIncrement('d20')">
          <img src="svg/v1/dice_d20.svg" width="24" height="24" />
        </button>
      </td>
      </tr></table>
      <button id="dialog_submit_standard" onclick="ui_submit_dice('standard')"
        class="btn modal-close">
        Submit
      </button>
    </section>
    <section class="dice_section" id="sw_dice_section">
      <a name="sw"></a>
      <h2 id="sw_dice_h2">SW / Genesys Dice</h2>
      <table><tr>
      <td>
        <input id="dice_input_sw_d61" type="text" value="1"/>
        <button class="btn" id="dice_button_sw_d61" onclick="diceIncrement('sw_d61')">
          <img src="svg/v1/dice_sw_d61.svg" width="24" height="24" />
        </button>
      </td>
      <td>
        <input id="dice_input_sw_d62" type="text" value="1"/>
        <button class="btn" id="dice_button_sw_d62" onclick="diceIncrement('sw_d62')">
          <img src="svg/v1/dice_sw_d62.svg" width="24" height="24" />
        </button>
      </td>
      <td>
        <input id="dice_input_sw_d81" type="text" value="1"/>
        <button class="btn" id="dice_button_sw_d81" onclick="diceIncrement('sw_d81')">
          <img src="svg/v1/dice_sw_d81.svg" width="24" height="24" />
        </button>
      </td>
      <td>
        <input id="dice_input_sw_d82" type="text" value="1"/>
        <button class="btn" id="dice_button_sw_d82" onclick="diceIncrement('sw_d82')">
          <img src="svg/v1/dice_sw_d82.svg" width="24" height="24" />
        </button>
      </td>
      <td>
        <input id="dice_input_sw_d121" type="text" value="1"/>
        <button class="btn" id="dice_button_sw_d121" onclick="diceIncrement('sw_d121')">
          <img src="svg/v1/dice_sw_d121.svg" width="24" height="24" />
        </button>
      </td>
      <td>
        <input id="dice_input_sw_d122" type="text" value="1"/>
        <button class="btn" id="dice_button_sw_d122" onclick="diceIncrement('sw_d122')">
          <img src="svg/v1/dice_sw_d122.svg" width="24" height="24" />
        </button>
      </td>
      <td>
        <input id="dice_input_sw_d123" type="text" value="1"/>
        <button class="btn" id="dice_button_sw_d123" onclick="diceIncrement('sw_d123')">
          <img src="svg/v1/dice_sw_d123.svg" width="24" height="24" />
        </button>
      </td>
      </tr></table>
      <button id="dialog_submit_sw" onclick="ui_submit_dice('sw')"
        class="btn modal-close">
        Submit
      </button>
    </section>
    <section class="dice_section" id="fudge_dice_section">
      <a name="fudge"></a>
      <h2 id="fudge_dice_h2">FUDGE (FATE) Dice</h2>
      <table><tr>
      <td>
        <input id="dice_input_fudge_d6" type="text" value="1"/>
        <button class="btn" id="dice_button_fudge_d6" onclick="diceIncrement('fudge_d6')">
          <img src="svg/v1/dice_fudge_d6.svg" width="24" height="24" />
        </button>
      </td>
      </tr></table>
      <button id="dialog_submit_fudge" onclick="ui_submit_dice('fudge')"
        class="btn modal-close">
        Submit
      </button>
    </section>
    <section class="dice_section" id="special_dice_section">
      <a name="special"></a>
      <h2 id="special_dice_h2">Special Dice</h2>
      <table><tr>
      <td>
        <input id="dice_input_dn" type="text" value="1"/>
        How many faces? <input
          id="dice_input_dn_num_faces" type="text" value="100" size="3"
          max="999" min="2"
        />
        <button class="btn" id="dice_button_dn" onclick="diceIncrement('dn')">
          <img id="img_dice_dn" src="svg/v1/dice_dn.svg" width="24" height="24" />
        </button>
      </td>
      <td>
        <input id="dice_input_dsymbol" type="text" value="1"/>
        Enter single numbers, letters or emoji, separated by spaces. <input
          id="dice_input_dsymbol_faces" type="text" value="0 1 ✗ ✔ y n" size="3"
          pattern="^.( .)*$"
        />
        <button class="btn" id="dice_button_dsymbol" onclick="diceIncrement('dsymbol')">
          <img id="img_dice_dsymbol" src="svg/v1/dice_dsymbol.svg" width="24" height="24" />
        </button>
      </td>
      </tr></table>
      <button id="dialog_submit_special" onclick="ui_submit_dice('special')"
        class="btn modal-close">
        Submit
      </button>
    </section>
  </div>
  </div>

<!-- END DIALOG_DICE ====================================== END DIALOG_DICE -->


<!-- RECT =========================================================== RECT -->

  <div class="modal" id="dialog_rect">
    <script>

var rect_verbs = {
  'Object properties': {
    applicable: () => { return true },
    eventName: 'object_properties',
    handler: (evt) => {
      console.log('rect hand', evt)
      ui_popup_properties(
        byId(evt.detail.elemId.substring('nest_'.length)),
        {'data-dialog-id': 'dialog_properties'}
      )
    }
  },
}

function make_rect(attrs) {
  var rect = svg_table.rect()
  rect.attr(Object.assign({
    'data-app-class': 'rect',
    id: 'rect_' + base32.short_id(),
    rx: 0,
    ry: 0,
    width: 100,
    height: 50,
    fill: '#fff59d',
    stroke: 'black',
    'fill-opacity': 0.9,
    'stroke-opacity': 0.9,
    'stroke-width': 1,
  }, attrs))

  var nest = make_nest({
    'id': 'nest_' + rect.attr('id'), // special ID
    'data-nest-for': 'rect',
    'width': rect.rbox().width,
    'height': rect.rbox().height,
  })

  nest.add(rect)

  hookup_ui(nest.node)
  hookup_menu_actions(nest.node, rect_verbs)
  return nest;
}

function ui_submit_rect(evt) {
  w = parseInt(byId('rect_input_width').value);
  h = parseInt(byId('rect_input_height').value);
  color = byId('rect_input_color').value;
  if (!w || !h || !color ) {
    return;
  }
  var nest = make_rect({
    width: w,
    height: h,
    fill: color,
  });
  ui_popdown_dialog('dialog_rect')
  net_fire({ type: 'create', data: serialize(nest) })
}

    </script>
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_rect"
    >
      &#215;
    </button>
  <div class="modal-content">
    <label for="rect_input_width">Width</label>
    <input id="rect_input_width" type="text" value="100"/>
    <br />
    <label for="rect_input_height">Height</label>
    <input id="rect_input_height" type="text" value="50"/>
    <br />
    <label for="rect_input_color">Color <span id="colorsample">■</span></label>
    <input id="rect_input_color" type="text" value="#ffff00"
           onKeyUp="updateColorSample(this)"
    />
    <br />
    <button id="dialog_submit" onclick="ui_submit_rect(this)"
      class="btn modal-close">
      Create
    </button>
  </div>
  </div>

<!-- END RECT =================================================== END RECT -->


<!-- RANDOM_TABLE =========================================== RANDOM_TABLE -->

  <div class="modal" id="dialog_random_table">
    <script>

function make_random_table(attrs, content) {
  var padding = 8
  var text = svg_table.plain('')
  var tspan = text.tspan(content)
  text.attr(Object.assign({
    'data-app-class': 'random_table',
    id: 'random_table_' + base32.short_id(),
    fill: '#000000',
    stroke: 'black',
    x: 0,
    y: 0,
    'stroke-opacity': 0,
    'font-weight': 'normal',
    'font-size': '12pt',
  }, attrs))
  var rbox = text.rbox()
  text.y(0)
  text.x(padding/2)

  var rect = svg_table.rect()
  rect.attr(Object.assign({
    id: 'rect_' + text.attr('id'), // special ID
    rx: 5,
    ry: 5,
    fill: '#ffffff',
    stroke: 'black',
    'fill-opacity': 0.5,
    'stroke-opacity': 0.5,
    'stroke-width': 1,
  }, {
    width: rbox.width + padding,
    height: rbox.height
  }))
  rect.addClass('text-rect')

  var nest = make_nest({
    'id': 'nest_' + text.attr('id'), // special ID
    'data-nest-for': 'text',
    x: 0,
    y: 0,
    width: rect.width(),
    height: rect.height() * 2,
  })
  nest.addClass('draggable-group')
  rect.y(rect.y() + (rect.height()/2))
  nest.add(rect)
  text.y(text.y() + (rect.height()/2))
  nest.add(text)

  hookup_ui(nest.node)
  hookup_menu_actions(nest.node, text_verbs)
  return nest;
}

function ui_submit_random_table(evt) {
  c = byId('random_table_input_content').value;

  color = byId('random_table_input_color').value;
  if (!c || !color ) {
    return;
  }
  var random_table = add_object(
      'svg/v1/random_table.svg',
      {
        'serializedState': { content: c },
        'color': color,
      },
    )
  byId('random_table_input_content').value = ''
  ui_popdown_dialog('dialog_random_table')
  net_fire({ type: 'create', data: serialize(random_table) })
}

    </script>
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_random_table"
    >
      &#215;
    </button>
  <div class="modal-content">
    <label for="random_table_input_content">Content</label>
    <textarea id="random_table_input_content" >
    Option 1
    Option 2
    Option 3
    </textarea>
    <br />
    <label for="random_table_input_color">Color <span id="colorsample">■</span></label>
    <input id="random_table_input_color" type="text" value="#1f1f1f"
           onKeyUp="updateColorSample(this)"
    />
    <br />
    <button id="dialog_submit" onclick="ui_submit_random_table(this)"
      class="btn modal-close">
      Create
    </button>
  </div>
  </div>

<!-- END RANDOM_TABLE =================================== END RANDOM_TABLE -->


<!-- TEXT =========================================================== TEXT -->

  <div class="modal" id="dialog_text">
    <script>

var text_verbs = {
  'Object properties': {
    applicable: () => { return true },
    eventName: 'object_properties',
    handler: (evt) => {
      id = evt.detail.elemId.substring('nest_'.length)
      el = byId(id)
      ui_popup_properties(
        el,
        {'data-dialog-id': 'dialog_properties'}
      )
    }
  },
}


function make_text(attrs, content) {
  var padding = 8
  var text = svg_table.plain('')
  var tspan = text.tspan(content)
  text.attr(Object.assign({
    'data-app-class': 'text',
    id: 'text_' + base32.short_id(),
    fill: '#000000',
    stroke: 'black',
    x: 0,
    y: 0,
    'stroke-opacity': 0,
    'font-weight': 'normal',
    'font-size': '12pt',
  }, attrs))
  var rbox = text.rbox()
  //console.log('text y', text.y())
  //console.log('text rbox', rbox)
  text.y(0)
  text.x(padding/2)
  //console.log('text y', text.y())
  //console.log('text rbox', text.rbox())

  var rect = svg_table.rect()
  rect.attr(Object.assign({
    id: 'rect_' + text.attr('id'), // special ID
    rx: 5,
    ry: 5,
    fill: '#ffffff',
    stroke: 'black',
    'fill-opacity': 0.5,
    'stroke-opacity': 0.5,
    'stroke-width': 1,
  }, {
    width: rbox.width + padding,
    height: rbox.height
  }))
  rect.addClass('text-rect')

  var nest = make_nest({
    'id': 'nest_' + text.attr('id'), // special ID
    'data-nest-for': 'text',
    x: 0,
    y: 0,
    width: rect.width(),
    height: rect.height() * 2,
  })
  nest.addClass('draggable-group')
  rect.y(rect.y() + (rect.height()/2))
  nest.add(rect)
  text.y(text.y() + (rect.height()/2))
  nest.add(text)
  //console.log('post insert text y', text.y())

  hookup_ui(nest.node)
  hookup_menu_actions(nest.node, text_verbs)
  return nest;
}

function ui_submit_text(evt) {
  c = byId('text_input_content').value;
  color = byId('text_input_color').value;
  if (!c || !color ) {
    return;
  }
  var text = make_text({ fill: color }, c);
  ui_popdown_dialog('dialog_text')
  net_fire({ type: 'create', data: serialize(text) })
}

    </script>
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_text"
    >
      &#215;
    </button>
  <div class="modal-content">
    <label for="text_input_content">Content</label>
    <input id="text_input_content" type="text" value="" Placeholder="Hello World"/>
    <br />
    <label for="text_input_color">Color <span id="colorsample">■</span></label>
    <input id="text_input_color" type="text" value="#ffff00"
           onKeyUp="updateColorSample(this)"
    />
    <br />
    <button id="dialog_submit" onclick="ui_submit_text(this)"
      class="btn modal-close">
      Create
    </button>
  </div>
  </div>

<!-- END TEXT =================================================== END TEXT -->


<!-- CIRCLE ========================================================CIRCLE -->

  <div class="modal" id="dialog_ellipse">
    <script>

var ellipse_verbs = {
  'Object properties': {
    applicable: () => { return true },
    eventName: 'object_properties',
    handler: (evt) => {
      console.log('ellipse handler')
      ui_popup_properties(
        byId(evt.detail.elemId.substring('nest_'.length)),
        {'data-dialog-id': 'dialog_properties'}
      )
    }
  },
}

function make_ellipse(attrs) {
  var ellipse = svg_table.ellipse()
  ellipse.attr(Object.assign({
    'data-app-class': 'ellipse',
    id: 'ellipse_' + base32.short_id(),
    rx: 100,
    ry: 50,
    cx: 50,
    cy: 50,
    fill: '#fff59d',
    stroke: 'black',
    'fill-opacity': 0.9,
    'stroke-opacity': 0.9,
    'stroke-width': 1,
  }, attrs))

  var nest = make_nest({
    'id': 'nest_' + ellipse.attr('id'), // special ID
    'data-nest-for': 'ellipse',
    'width': ellipse.rbox().width,
    'height': ellipse.rbox().height,
  })

  nest.add(ellipse)

  hookup_ui(nest.node)
  hookup_menu_actions(nest.node, ellipse_verbs)
  return nest;
}

function ui_submit_ellipse(evt) {
  w = parseInt(byId('ellipse_input_width').value);
  h = parseInt(byId('ellipse_input_height').value);
  color = byId('ellipse_input_color').value;
  if (!w || !h || !color ) {
    return;
  }
  var nest = make_ellipse({
    rx: w / 2,
    ry: h / 2,
    cx: w / 2,
    cy: h / 2,
    fill: color,
  });
  ui_popdown_dialog('dialog_ellipse')
  net_fire({ type: 'create', data: serialize(nest) })
}

    </script>
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_ellipse"
    >
      &#215;
    </button>
  <div class="modal-content">
    <label for="ellipse_input_width">Width</label>
    <input id="ellipse_input_width" type="text" value="100"/>
    <br />
    <label for="ellipse_input_height">Height</label>
    <input id="ellipse_input_height" type="text" value="50"/>
    <br />
    <label for="ellipse_input_color">Color <span id="colorsample">■</span></label>
    <input id="ellipse_input_color" type="text" value="#ffff00"
           onKeyUp="updateColorSample(this)"
    />
    <br />
    <button id="dialog_submit" onclick="ui_submit_ellipse(this)"
      class="btn modal-close">
      Create
    </button>
  </div>
  </div>

<!-- END CIRCLE =============================================== END CIRCLE -->


<!-- OTHER ======================================================= OTHER -->

  <div class="modal" id="dialog_other">
    <button class="dialog_cancel btn modal-close" data-dialog-id="dialog_other"
    > &#215; </button>
    <nav class="dialog_nav" id="dialog_dice_nav">
    <div class="nav-wrapper">
      <ul class="left">
        <li><a href="#drawing">Drawing</a></li>
        <li><a href="#rules">Rules</a></li>
      </ul>
    </div>
    </nav>
    <div class="modal-content">
    <section id="drawing_section">
      <a name="drawing"></a>
      <h2 id="drawing_h2">Drawing</h2>
      <button id="rect_button" class="btn btn-small modal-trigger modal-close"
        data-target="dialog_rect"
        data-dialog-id="dialog_rect">
        + Rectangle
      </button>
      <button id="ellipse_button" class="btn btn-small modal-trigger modal-close"
        data-target="dialog_ellipse"
        data-dialog-id="dialog_ellipse">
        + Circle
      </button>
      <button id="text_button" class="btn btn-small modal-trigger modal-close"
        data-target="dialog_text"
        data-dialog-id="dialog_text">
        + Text
      </button>
      <button id="random_table_button" class="btn btn-small modal-trigger modal-close"
        data-target="dialog_random_table"
        data-dialog-id="dialog_random_table">
        + Random Table
      </button>
    </section>
    <section id="rules_section">
      <a name="rules"></a>
      <h2 id="rules_h2">Rules</h2>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/rule_sum.svg')">
        + Sum
      </button>
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/rule_if.svg')">
        + If
      </button>
    </section>
    </div>
  </div>

<!-- END OTHER =============================================== END OTHER -->

<!-- CLOCKS ======================================================= CLOCKS -->

  <div class="modal" id="dialog_clocks">
    <button class="dialog_cancel btn modal-close" data-dialog-id="dialog_clocks"
    > &#215; </button>
    <div class="modal-content">
    <section id="clocks_section">
      <button class="btn btn-small modal-close"
        onclick="add_object('svg/v1/clock_6.svg')">
        + 6-Clock
      </button>
    </section>
    </div>
  </div>

<!-- END OTHER =============================================== END OTHER -->

<!-- CONTRIBUTE =============================================== CONTRIBUTE -->
  <div class="modal" id="dialog_contribute">
    <button class="dialog_cancel btn modal-close"
      data-dialog-id="dialog_contribute"
    >
      &#215;
    </button>
    If you enjoy this tool, you can spread the love:
    <nav class="dialog_nav" id="contribute_nav">
    <div class="nav-wrapper">
      <ul class="left">
        <li><a href="#recognize">Give some recognition</a></li>
        <li><a href="#develop">Contribute to the codebase</a></li>
        <li><a href="#donate">Donate to related causes</a></li>
      </ul>
    </div>
    </nav>
  <div class="modal-content">
    <section>
      <a name="recognize"></a>
      <h2 class="contribute_h2">Give some recognition</h2>
      <div class="contribute_explain">
      If you do the whole social media thing:
      <a href="https://twitter.com/home?status=Thanks be to @boardcrafting for
      hosting https://www.1kfa.com/table !">By tweeting a tweet</a> or
      <a href="https://mastodon.social/">tooting a toot</a>.
      <p>
      If you've got a Github account, you can 
      <a href="https://github.com/sjbrown/1kfa">Star this project</a>
      </div>
    </section>
    <section>
      <a name="develop"></a>
      <h2 class="contribute_h2">Contribute to the codebase</h2>
      <div class="contribute_explain">
      Speaking of Github, you can
      <a href="https://github.com/sjbrown/1kfa">fork and contribute to this project</a>
      </div>
    </section>
    <section>
      <a name="donate"></a>
      <h2 class="contribute_h2">Donate</h2>
      <div class="contribute_explain">
      This is built on top of TogetherJS, a free, open-source project created by
      the Mozilla Foundation. They need money to continue making great software
      like this.
      <a href="https://donate.mozilla.org/en-US/">Donate to Mozilla here.</a>
      </div>
    </section>
  </div>
  </div>
<!-- /CONTRIBUTE ============================================== /CONTRIBUTE -->



  <menu type="context" id="gamemenu">
    <template id="template_menuitem">
      <menuitem label="X"
      ></menuitem>
    </template>
    <menuitem label="Delete marked objects"
     onclick="delete_marked(this)"
    ></menuitem>
  </menu>

</body>
</html>

